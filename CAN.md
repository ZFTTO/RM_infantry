# é¥æ§ â†’ åº•ç›˜ CAN é€šä¿¡åè®®

## ğŸ“Š é€šä¿¡æ¶æ„

```
é¥æ§å™¨ (DR16)
    â†“ UART (DMA)
äº‘å°MCU (STM32G473)
    â”œâ”€ rcControlTask è¯»å–é¥æ§æ•°æ®
    â”œâ”€ è®¡ç®—é€Ÿåº¦ç›®æ ‡
    â””â”€ å‘é€ç»™åº•ç›˜MCU
    â†“ FDCAN (CANæ€»çº¿)
åº•ç›˜MCU (STM32F407/å…¶ä»–)
    â”œâ”€ æ¥æ”¶é€Ÿåº¦å‘½ä»¤
    â”œâ”€ æ§åˆ¶å››ä¸ªç”µæœº
    â””â”€ åé¦ˆå½“å‰çŠ¶æ€ (å¯é€‰)
```

---

## ğŸ“ CAN å¸§æ ¼å¼å®šä¹‰

### **å‘é€å¸§ï¼šäº‘å°MCU â†’ åº•ç›˜MCU**

```
CAN ID: 0x100 (äº‘å°æ§åˆ¶å‘½ä»¤)
Data Length: 8 bytes
Frequency: 100Hz (10ms)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Byte    â”‚ å«ä¹‰    â”‚ æ•°å€¼èŒƒå›´                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0-1     â”‚ vx      â”‚ -2.0 ~ +2.0 m/s          â”‚
â”‚ 2-3     â”‚ vy      â”‚ -2.0 ~ +2.0 m/s          â”‚
â”‚ 4-5     â”‚ omega   â”‚ -3.14 ~ +3.14 rad/s      â”‚
â”‚ 6       â”‚ mode    â”‚ bit0=ç‰¹æ®Š, bit1=è§†è§‰     â”‚
â”‚ 7       â”‚ reserve â”‚ é¢„ç•™                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **å­—èŠ‚ç¼–ç æ–¹å¼**

#### **vx (å‰åé€Ÿåº¦) - Byte 0-1**
```
åŸå§‹å€¼: -2.0 ~ +2.0 m/s
ç¼–ç : int16_t = (floatå€¼) * 16383.5
è§£ç : float = (int16_tå€¼) / 16383.5

ä¾‹:
  vx = 1.0 m/s  â†’ int16 = 16383  â†’ canData[0:1] = 0x3FFF
  vx = 0.0 m/s  â†’ int16 = 0      â†’ canData[0:1] = 0x0000
  vx = -1.0 m/s â†’ int16 = -16383 â†’ canData[0:1] = 0xC001
```

#### **vy (å·¦å³é€Ÿåº¦) - Byte 2-3**
```
åŸå§‹å€¼: -2.0 ~ +2.0 m/s (åŒ vx)
ç¼–ç : int16_t = (floatå€¼) * 16383.5
```

#### **omega (æ—‹è½¬é€Ÿåº¦) - Byte 4-5**
```
åŸå§‹å€¼: -3.14 ~ +3.14 rad/s
ç¼–ç : int16_t = (floatå€¼) * 10430.4  (= 32767 / 3.14)
è§£ç : float = (int16_tå€¼) / 10430.4

ä¾‹:
  omega = 1.57 rad/s (Ï€/2)  â†’ int16 = 16367 â†’ canData[4:5] = 0x3FAF
  omega = 0.0 rad/s         â†’ int16 = 0     â†’ canData[4:5] = 0x0000
```

#### **mode (æ¨¡å¼æ ‡å¿—) - Byte 6**
```
bit0: ç‰¹æ®Šæ¨¡å¼ (S1==UP)
bit1: è§†è§‰è‡ªç„ (é¼ æ ‡å·¦é”®)
bit2~7: é¢„ç•™

ä¾‹: æ™®é€šæ¨¡å¼ mode = 0x00
    è§†è§‰æ¨¡å¼ mode = 0x02
```

---

## ğŸ® é¥æ§æ˜ å°„è¡¨

### **æ‘‡æ†åˆ°é€Ÿåº¦çš„æ˜ å°„**

```
é€šé“æ˜ å°„:
Ch0 (Roll)    â†’ vy (å·¦å³ç§»åŠ¨)
Ch1 (Pitch)   â†’ vx (å‰åç§»åŠ¨)
Ch3 (Yaw)     â†’ omega (æ—‹è½¬)

èŒƒå›´è½¬æ¢:
é¥æ§: [364, 1024, 1684]
å½’ä¸€åŒ–: [-1.0, 0.0, 1.0]
é€Ÿåº¦: [-MAX, 0.0, +MAX]
```

### **å¼€å…³æ˜ å°„**

```
Switch1 ä½ç½®:
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚UP    â”‚ å…¨é€Ÿæ¨¡å¼ (vx/vy max=2.0)  â”‚
â”‚MID   â”‚ åŠé€Ÿæ¨¡å¼ (vx/vy max=1.0)  â”‚
â”‚DOWN  â”‚ åœæ­¢æ¨¡å¼ (vx/vy=0)        â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Switch2 ä½ç½®:
â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚UP    â”‚ ç‰¹æ®Šæ¨¡å¼ (mode bit0=1)    â”‚
â”‚MID   â”‚ æ™®é€šæ¨¡å¼ (mode bit0=0)    â”‚
â”‚DOWN  â”‚ æ™®é€šæ¨¡å¼ (mode bit0=0)    â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **é¼ æ ‡æ˜ å°„**

```
é¼ æ ‡å·¦é”®: è§†è§‰è‡ªç„æ¨¡å¼ (mode bit1=1)
```

---

## ğŸ’¾ ä»£ç å®ç°è¯¦è§£

### **1. CAN å¸§æ‰“åŒ…**

```cpp
// åˆ›å»º CAN TX Header
CAN_TXHEADER_T txHeader = CANManager::getTxHeader(0x100);

// å‡†å¤‡ 8 å­—èŠ‚æ•°æ®
uint8_t canData[8];

// ç¼–ç  vx
int16_t vx_scaled = (int16_t)(chassisCmd.vx * 16383.5f);
canData[0] = (vx_scaled >> 8) & 0xFF;   // é«˜å­—èŠ‚
canData[1] = vx_scaled & 0xFF;          // ä½å­—èŠ‚

// ç¼–ç  vy
int16_t vy_scaled = (int16_t)(chassisCmd.vy * 16383.5f);
canData[2] = (vy_scaled >> 8) & 0xFF;
canData[3] = vy_scaled & 0xFF;

// ç¼–ç  omega
int16_t omega_scaled = (int16_t)(chassisCmd.omega * 10430.4f);
canData[4] = (omega_scaled >> 8) & 0xFF;
canData[5] = omega_scaled & 0xFF;

// ç¼–ç  mode
canData[6] = (switch2 == DR16::SW_UP) ? 0x01 : 0x00;
if (mouse_left) canData[6] |= 0x02;

canData[7] = 0;  // Reserved

// å‘é€
canManager.transmit(txHeader, canData);
```

### **2. åº•ç›˜ MCU æ¥æ”¶å’Œè§£ç **

```cpp
// åœ¨åº•ç›˜ MCU çš„ CAN æ¥æ”¶å›è°ƒä¸­

void chassisRxCallback(const uint8_t *rxBuffer, const uint16_t id, const uint8_t canIndex)
{
    if (id == 0x100)  // äº‘å°å‘½ä»¤
    {
        // è§£ç  vx
        int16_t vx_scaled = ((int16_t)rxBuffer[0] << 8) | rxBuffer[1];
        float vx = vx_scaled / 16383.5f;
        
        // è§£ç  vy
        int16_t vy_scaled = ((int16_t)rxBuffer[2] << 8) | rxBuffer[3];
        float vy = vy_scaled / 16383.5f;
        
        // è§£ç  omega
        int16_t omega_scaled = ((int16_t)rxBuffer[4] << 8) | rxBuffer[5];
        float omega = omega_scaled / 10430.4f;
        
        // è§£ç  mode
        bool special_mode = (rxBuffer[6] & 0x01) != 0;
        bool vision_mode = (rxBuffer[6] & 0x02) != 0;
        
        // è°ƒç”¨åº•ç›˜æ§åˆ¶å™¨
        chassisController.setVelocity(vx, vy, omega);
        
        if (special_mode) {
            // æ‰§è¡Œç‰¹æ®Šæ¨¡å¼
        }
        if (vision_mode) {
            // å¯ç”¨è§†è§‰è‡ªç„
        }
    }
}
```

---

## âš™ï¸ AppConfig.h é…ç½®

ç¡®ä¿å·²å¯ç”¨ CANï¼š

```cpp
/*=================*
   CAN CONFIG
 *=================*/
#define USE_CAN_MANAGER 1

#if USE_CAN_MANAGER
    #define CAN_NUM 1           // ä½¿ç”¨ 1 ä¸ª CAN (FDCAN1)
    #define CAN_FILTER_NUM 8    // æœ€å¤š 8 ä¸ªè¿‡æ»¤å™¨
#endif

/*=============*
   DR16 CONFIG
 *=============*/
#define USE_DR16 1

#if USE_DR16
    #if defined(STM32G473xx)
        #define DR16_UART huart1  // é¥æ§æ¥æ”¶å™¨ UART
    #endif
#endif
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### **1. ç¡¬ä»¶è¿æ¥æ£€æŸ¥**
```
â–¡ DR16 é¥æ§å™¨ â†’ STM32G473 (huart1)
â–¡ STM32G473 â†’ åº•ç›˜MCU (FDCAN)
â–¡ CAN æ€»çº¿æœ‰ 120Î© ç»ˆç«¯ç”µé˜»
```

### **2. åˆå§‹åŒ–æ£€æŸ¥**
```
â–¡ DR16::init() è°ƒç”¨æˆåŠŸ
â–¡ canManager.init(&hfdcan1) è°ƒç”¨æˆåŠŸ
â–¡ rcControlTask åˆ›å»ºæˆåŠŸ
```

### **3. æ•°æ®æµæ£€æŸ¥**
```
â–¡ DR16 LED é—ªçƒ (æ¥æ”¶åˆ°é¥æ§æ•°æ®)
â–¡ è°ƒè¯•å™¨ç›‘æ§ chassisCmd å€¼å˜åŒ–
â–¡ CAN æ€»çº¿æœ‰æ•°æ®å‘é€ (ç›‘æ§ txCountFifoQ)
â–¡ åº•ç›˜ MCU æ¥æ”¶åˆ°æ•°æ®
```

### **4. åŠŸèƒ½æµ‹è¯•**
```
â–¡ æ¨åŠ¨å·¦æ‘‡æ†å‰å â†’ vx å˜åŒ–
â–¡ æ¨åŠ¨å·¦æ‘‡æ†å·¦å³ â†’ vy å˜åŒ–
â–¡ æ¨åŠ¨å³æ‘‡æ† â†’ omega å˜åŒ–
â–¡ åˆ‡æ¢å¼€å…³ S1 â†’ é€Ÿåº¦é™åˆ¶å˜åŒ–
â–¡ RC æ–­è¿ â†’ ç«‹å³åœæ­¢
```

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

```cpp
// å¯ä»¥åœ¨è°ƒè¯•å™¨ä¸­ç›‘æ§

// DR16 æ€§èƒ½
uint32_t dr16_receive_counter;      // æ¥æ”¶è®¡æ•° (åº”è¯¥æ¯10ms+1)
bool rc_connected;                  // è¿æ¥çŠ¶æ€

// CAN æ€§èƒ½
volatile uint32_t txCountFifoQ;     // å‘é€æˆåŠŸè®¡æ•°
volatile uint8_t qLevel;            // é˜Ÿåˆ—æ·±åº¦
volatile uint32_t busOffCount;      // æ€»çº¿ç¦»çº¿æ¬¡æ•°
```

---

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|--------|
| CAN æ— æ•°æ®å‘é€ | init() æœªè°ƒç”¨ | æ£€æŸ¥ startUserTasks() |
| æ•°æ®ä¹±ç  | å­—èŠ‚åºé”™è¯¯ | æ£€æŸ¥é«˜ä½å­—èŠ‚é¡ºåº |
| åº•ç›˜ä¸åŠ¨ | é€Ÿåº¦å€¼æœªåˆ°è¾¾ | ç›‘æ§ CAN æ€»çº¿ |
| æ–­è¿åä¸åœæ­¢ | failsafe æœªå®ç° | æ£€æŸ¥ else åˆ†æ”¯ |

---

## ğŸ“Œ å…³é”®ä»£ç ä½ç½®

```
UserTask.cpp:
â”œâ”€ ChassisCommand ç»“æ„ (å®šä¹‰é€Ÿåº¦)
â”œâ”€ rcControlTask() (è¯»é¥æ§, å‘CAN)
â””â”€ startUserTasks() (åˆå§‹åŒ–)

AppConfig.h:
â”œâ”€ USE_DR16 = 1
â””â”€ USE_CAN_MANAGER = 1
```

å®Œæˆï¼é¥æ§ä¿¡å·ç°åœ¨æµå‘åº•ç›˜MCUäº†ã€‚
